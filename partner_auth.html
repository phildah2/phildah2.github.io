<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auth0 Integration with Voiceflow</title>
    <script src="https://cdn.auth0.com/js/auth0/9.16/auth0.min.js"></script>
</head>
<body>

    <h1>Welcome to My App</h1>
    <button id="login">Log In</button>
    <button id="logout" style="display:none;">Log Out</button>
    <script type="text/javascript"> 
        var webAuth = new auth0.WebAuth({
            domain: 'dev-aili3g0kbihxihy2.us.auth0.com',
            clientID: 'KPKdSC2G8o6fU6CYm3l72Q9cpyuHXQPb',
            redirectUri: window.location.href,
            responseType: 'token id_token',
            scope: 'openid profile email'
        });

        document.getElementById('login').addEventListener('click', function() {
            webAuth.authorize();
        });

        window.onload = function() {
            webAuth.parseHash(function(err, authResult) {
                if (authResult && authResult.accessToken && authResult.idToken) {
                    localStorage.setItem('accessToken', authResult.accessToken);
                    window.location.hash = '';

                    document.getElementById('logout').style.display = 'block';
                    document.getElementById('login').style.display = 'none';
                    
                    var userID = 'user_' + Math.random().toString(36).substring(2, 15);
                    localStorage.setItem('userID', userID);

                    function updateVoiceflowUserToken(userID, accessToken) {
                        const headers = {
                            'Authorization': 'VF.DM.6560d8ad9599e20007a2c2ce.viX11KIRDWhGxsaE',
                            'Content-Type': 'application/json',
                            'versionID': 'production' // or 'production', as appropriate
                        };

                        const body = {
                            variables: {
                                UserToken: accessToken // Pass the accessToken as the UserToken
                            }
                        };

                        console.log('Updating Voiceflow variables with:', body);
                        fetch(`https://general-runtime.voiceflow.com/state/user/${userID}/variables`, {
                            method: 'PATCH',
                            headers: headers,
                            body: JSON.stringify(body),
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Voiceflow variables updated:', data);
                        })
                        .catch(error => {
                            console.error('Error updating Voiceflow variables:', error);
                        });
                    }

                    // Call the function with the correct parameters
                    updateVoiceflowUserToken(userID, authResult.accessToken);

                    (function(d, t) {
                        var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
                        v.onload = function() {
                            window.voiceflow.chat.load({
                                verify: { projectID: '6560d8ad9599e20007a2c2cd' },
                                url: 'https://general-runtime.voiceflow.com',
                                versionID: 'production',
                                userID: userID, // Pass the userID to the chat widget
                                UserToken: authResult.accessToken,
                            });
                        };
                        v.src = "https://cdn.voiceflow.com/widget/bundle.mjs"; 
                        v.type = "text/javascript"; 
                        s.parentNode.insertBefore(v, s);
                    })(document, 'script');
                } else if (err) {
                    console.error("Error parsing the authentication hash:", err);
                }
            });

            document.getElementById('logout').addEventListener('click', function() {
                webAuth.logout({
                    returnTo: 'https://phildah2.github.io/partner_auth.html' // Replace with your return URL
                });
            });
        };
    </script>
</body>
</html>
