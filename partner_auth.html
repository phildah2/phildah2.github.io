<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auth0 Integration with Voiceflow</title>
    <script src="https://cdn.auth0.com/js/auth0/9.16/auth0.min.js"></script>
</head>
<body>

    <h1>Welcome to My App</h1>
    <button id="login">Log In</button>
    <button id="logout" style="display:none;">Log Out</button>
    <script type="text/javascript"> 
        var webAuth = new auth0.WebAuth({
            domain: 'dev-aili3g0kbihxihy2.us.auth0.com',
            clientID: 'KPKdSC2G8o6fU6CYm3l72Q9cpyuHXQPb',
            redirectUri: window.location.href,
            responseType: 'token id_token',
            scope: 'openid profile email'
        });

        document.getElementById('login').addEventListener('click', function() {
    webAuth.authorize({
        audience: 'https://phildah2.github.io/partner_auth.html#' // Replace with your actual API Identifier
    });
});

function getIPAddress(callback) {
    fetch('https://api64.ipify.org?format=json')
        .then(response => response.json())
        .then(data => {
            const ipAddress = data.ip;
            callback(ipAddress);
        })
        .catch(error => {
            console.error('Error fetching IP address:', error);
            callback(null);
        });
}

window.onload = function() {
    webAuth.parseHash(function(err, authResult) {
        if (authResult && authResult.accessToken && authResult.idToken) {
            localStorage.setItem('accessToken', authResult.accessToken);
            window.location.hash = '';

            document.getElementById('logout').style.display = 'block';
            document.getElementById('login').style.display = 'none';

            var userID = 'user_' + Math.random().toString(36).substring(2, 15);
            localStorage.setItem('userID', userID);

            // Get the user's IP address
            getIPAddress(function(ipAddress) {
                // Create the launch event payload with the user's IP address
                var launchPayload = {
                    userToken: authResult.accessToken,
                    ipAddress: ipAddress  // Add the IP address here
                };

                window.voiceflow.chat.load({
                    verify: { projectID: '6560d8ad9599e20007a2c2cd' },
                    url: 'https://general-runtime.voiceflow.com',
                    versionID: 'production',
                    userID: userID,
                     launch: { event: {type: "launch", payload: {userToken: authResult.accessToken, IP: ipAdress}}}
                });
            });
        } else if (err) {
            console.error("Error parsing the authentication hash:", err);
        }
    });

    document.getElementById('logout').addEventListener('click', function() {
        webAuth.logout({
            returnTo: 'https://phildah2.github.io/partner_auth.html'
        });
    });
};


    </script>
</body>
</html>
